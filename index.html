<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPDATE ความก้าวหน้างานโครงการ VAY CHINNAKHET</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- SUPABASE LIBRARY -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .main-container {
            max-width: 1600px;
        }
        .progress-bar-bg { background-color: #e2e8f0; } /* slate-200 */
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
        .task-item { transition: all 0.2s ease-in-out; border-left-width: 4px; }
        .task-item.completed {
            background-color: #f0fdf4;
            color: #166534; /* green-800 */
            border-left-color: #4ade80 !important; /* green-400 */
        }
        .task-item:not(.completed):hover { background-color: #f1f5f9; } /* slate-100 */
        .task-item.delayed {
            background-color: #fff1f2;
            color: #be123c; /* rose-700 */
            border-left-color: #f43f5e !important; /* rose-500 */
        }
        .task-item.delayed .text-gray-500 { color: #be123c; }
        .task-item.delayed .due-date-input { border-color: #f43f5e; background-color: #ffe4e6; }

        .floor-btn.active { background-color: #1e293b; color: white; } /* slate-800 */
        .floor-btn { background-color: #f1f5f9; color: #475569; } /* slate-100, slate-600 */
        .floor-btn:hover { background-color: #e2e8f0; } /* slate-200 */

        .due-date-input { width: auto; display: inline-block; padding: 2px 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px; color: #334155; }

        #report-page::-webkit-scrollbar, .modal-content::-webkit-scrollbar { width: 8px; }
        #report-page::-webkit-scrollbar-track, .modal-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #report-page::-webkit-scrollbar-thumb, .modal-content::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        #report-page::-webkit-scrollbar-thumb:hover, .modal-content::-webkit-scrollbar-thumb:hover { background: #aaa; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(15, 23, 42, 0.6); display: flex; align-items: center; justify-content: center;
            z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; backdrop-filter: blur(4px);
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: white; padding: 1.5rem 2rem 2rem 2rem; border-radius: 0.75rem;
            width: 90%; max-width: 800px; transform: translateY(20px); transition: transform 0.3s;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.visible .modal-content { transform: translateY(0); }

        /* Report Table Styles */
        .report-table-wrapper {
            overflow: auto;
            max-height: calc(100vh - 250px); /* Adjust height for fuller page */
        }
        .report-table { border-collapse: separate; border-spacing: 0; width: 100%; }
        .report-table th, .report-table td {
            border-bottom: 1px solid #e2e8f0; /* slate-200 */
            border-right: 1px solid #e2e8f0;
            padding: 0.5rem 0.75rem;
            white-space: nowrap;
        }
        .report-table th:first-child, .report-table td:first-child {
            position: sticky; left: 0;
            background-color: #f8fafc; /* slate-50 */
            border-left: 1px solid #e2e8f0;
            z-index: 30;
        }
        .report-table thead th {
            position: sticky; top: 0;
            /* background-color is now set dynamically */
            z-index: 20;
            font-weight: 600; text-align: center;
            vertical-align: bottom;
            font-size: 0.875rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        .report-table thead th:first-child { z-index: 40; }
        .report-table th.room-header { vertical-align: middle; }
        .report-table th div { line-height: 1.2; }
        .report-table td { font-size: 0.875rem; text-align: center; transition: background-color 0.2s; }
        .report-table.multi-select-mode td[data-task-id]:hover {
             cursor: pointer; background-color: #eff6ff; /* blue-100 */
        }
        .report-table:not(.multi-select-mode) td[data-task-id]:hover {
            cursor: pointer; background-color: #f0f9ff; /* sky-50 */
        }
        .report-table td.selected {
            background-color: #e0e7ff !important; /* indigo-100 */
            box-shadow: inset 0 0 0 2px #6366f1; /* indigo-500 */
        }

        .view-btn { transition: all 0.2s ease-in-out; }
        .view-btn.active { background-color: white; color: #334155; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .view-btn:not(.active) { color: #64748b; }

        /* Report Type Tabs */
        .report-type-btn {
            border-bottom: 2px solid transparent;
            margin-bottom: -1px; /* To align with the container's border */
            transition: all 0.2s ease-in-out;
        }
        .report-type-btn.active {
            border-bottom-color: #6366f1; /* indigo-500 */
            color: #4f46e5; /* indigo-600 */
        }

        /* Multi-select toggle */
        #multi-select-toggle:checked ~ .dot { transform: translateX(100%); }
        #multi-select-toggle:checked ~ .bg-gray-300 { background-color: #4f46e5; } /* indigo-600 */
        
        /* TV Mode Styles */
        body.tv-mode { padding: 1rem; }
        body.tv-mode #report-page.page-container {
            height: calc(100vh - 2rem);
            display: flex;
            flex-direction: column;
            padding: 0;
            border-radius: 0.75rem; /* Maintain rounded corners */
            overflow: hidden; /* Clip content within rounded corners */
        }
        body.tv-mode #report-page .report-table-wrapper {
            flex-grow: 1;
            max-height: none;
        }
        body.tv-mode #report-page .app-header { /* Hide main header and back button */
            display: none;
        }
        body.tv-mode #report-page .top-controls { /* Adjust top controls bar */
            justify-content: space-between; /* Allow floor selector and other controls to space out */
            padding: 0.5rem 1rem;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        body.tv-mode #report-page .top-controls .ml-3 { /* Hide multi-select text label */
             display: none;
        }
        body.tv-mode #multi-select-actions { /* Ensure multi-select bar is visible and usable */
            position: static; /* Make it part of the normal document flow */
            border-radius: 0;
            box-shadow: none;
            border-top: none;
            border-left: none;
            border-right: none;
        }


        /* Cover Page */
        .menu-card {
            background-color: white;
            border: 1px solid #e2e8f0; /* slate-200 */
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            font-weight: 600;
            color: #334155; /* slate-700 */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .menu-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            border-color: #c7d2fe; /* indigo-200 */
            color: #4338ca; /* indigo-700 */
        }
        .page-container {
             background-color: white;
             border-radius: 1.5rem;
             border: 1px solid #e2e8f0; /* slate-200 */
             padding: 1.5rem 2rem; /* p-6 md:p-8 */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="main-container mx-auto">
        <!-- Cover Page (Main Menu) -->
        <div id="cover-page">
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-bold text-slate-800">ความคืบหน้าโครงการ VAY CHINNAKHET</h1>
                <p class="text-slate-500 mt-2 text-lg">กรุณาเลือกเมนูที่ต้องการ</p>
            </div>
            <div id="main-menu-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6 max-w-5xl mx-auto">
                <!-- JS will populate menu cards here -->
            </div>
        </div>
        
        <!-- App Container for all other pages -->
        <div id="app-container" class="hidden">
            <!-- Report Page -->
            <div id="report-page" class="hidden page-container">
                <div class="app-header flex items-center mb-6">
                    <button class="back-to-menu-btn bg-white border border-slate-300 rounded-md p-2 hover:bg-slate-50 transition" title="กลับไปหน้าหลัก">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    </button>
                    <h2 id="report-page-title" class="text-2xl font-bold text-slate-800 ml-4">รายงานสรุปงาน WETWORK</h2>
                </div>
                <div class="flex items-center border-b border-slate-200 mb-4">
                    <button class="report-type-btn active px-4 py-2 text-sm font-semibold" data-report-type="wetwork">WETWORK</button>
                    <button class="report-type-btn px-4 py-2 text-sm font-semibold text-slate-500 hover:text-slate-700" data-report-type="endproduct">ENDPRODUCT</button>
                </div>
                <div class="top-controls flex flex-col sm:flex-row justify-between items-center gap-4 mb-4">
                    <div class="flex items-center gap-4">
                        <label for="report-floor-filter" class="font-semibold text-slate-700">เลือกชั้น:</label>
                        <select id="report-floor-filter" class="text-sm border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                    <div class="flex items-center gap-3">
                         <button id="toggle-tv-mode-btn" class="text-sm bg-slate-200 text-slate-700 px-3 py-1.5 rounded-md hover:bg-slate-300 transition flex items-center gap-2" title="โหมดทีวี (เต็มจอ)">
                             <svg id="tv-mode-icon-expand" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-1a1 1 0 00-1 1v2a1 1 0 002 0V6h2a1 1 0 100-2H5zM5 15a1 1 0 011-1h2a1 1 0 110 2H5v-1zm11-1a1 1 0 00-1-1h-2a1 1 0 100 2h2v-1zM14 5a1 1 0 011 1v2a1 1 0 11-2 0V5h1z" clip-rule="evenodd" /></svg>
                             <svg id="tv-mode-icon-compress" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2a1 1 0 00-1 1v2a1 1 0 002 0V4h2a1 1 0 100-2H5zm10 0a1 1 0 00-1 1v3a1 1 0 102 0V3a1 1 0 00-1-1zM5 14a1 1 0 00-1 1v3a1 1 0 102 0v-2h2a1 1 0 100-2H5zm11-1a1 1 0 011 1v2a1 1 0 11-2 0v-1h-2a1 1 0 110-2h3z" clip-rule="evenodd" /></svg>
                         </button>
                         <label for="multi-select-toggle" class="flex items-center cursor-pointer">
                             <div class="relative"><input type="checkbox" id="multi-select-toggle" class="sr-only"><div class="block bg-gray-300 w-10 h-6 rounded-full"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div></div>
                             <div class="ml-3 text-sm font-medium text-slate-700">เลือกหลายรายการ</div>
                         </label>
                    </div>
                </div>
                <div id="multi-select-actions" class="hidden sticky top-0 z-30 bg-white/80 backdrop-blur-sm p-2 rounded-lg shadow-md border border-slate-200 mb-4 flex-wrap items-center gap-3">
                    <span id="multi-select-count" class="text-sm font-bold text-slate-700">เลือก: 0</span>
                    <button id="multi-complete-btn" class="text-sm bg-green-500 text-white px-3 py-1.5 rounded-md hover:bg-green-600">ทำเครื่องหมายว่าเสร็จสิ้น</button>
                    <div class="flex items-center gap-2"><input type="date" id="multi-set-date-input" class="text-sm border-slate-300 rounded-md p-1"><button id="multi-set-date-btn" class="text-sm bg-blue-500 text-white px-3 py-1.5 rounded-md hover:bg-blue-600">กำหนดวันที่</button></div>
                     <div class="flex items-center gap-2"><input type="text" id="multi-set-note-input" class="text-sm border-slate-300 rounded-md p-1" placeholder="เพิ่มโน้ต..."><button id="multi-set-note-btn" class="text-sm bg-gray-500 text-white px-3 py-1.5 rounded-md hover:bg-gray-600">เพิ่มโน้ต</button></div>
                    <div class="flex items-center gap-2 border-l pl-3 ml-1"><input type="text" id="multi-set-followup-text-input" class="text-sm border-slate-300 rounded-md p-1" placeholder="เพิ่มงานต้องเก็บ..."><input type="date" id="multi-set-followup-date-input" class="text-sm border-slate-300 rounded-md p-1"><button id="multi-set-followup-btn" class="text-sm bg-purple-500 text-white px-3 py-1.5 rounded-md hover:bg-purple-600">เพิ่มงานต้องเก็บ</button></div>
                    <button id="multi-complete-followup-btn" class="text-sm bg-teal-500 text-white px-3 py-1.5 rounded-md hover:bg-teal-600" title="ทำเครื่องหมายว่างานต้องเก็บแล้วเสร็จ">เก็บงานแล้วเสร็จ</button>
                    <button id="multi-clear-btn" class="text-sm bg-red-500 text-white px-3 py-1.5 rounded-md hover:bg-red-600" title="รีเซ็ตสถานะงานที่เลือกทั้งหมด">ล้างค่า</button>
                </div>
                <div id="report-table-container" class="report-table-wrapper"></div>
                 <div class="mt-4 flex justify-end">
                    <button id="export-report-image-btn" class="text-sm bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>ส่งออกเป็นภาพ</button>
                </div>
            </div>
            
            <!-- Text Report Page -->
            <div id="text-report-page" class="hidden page-container">
                 <div class="flex items-center mb-6">
                    <button class="back-to-menu-btn bg-white border border-slate-300 rounded-md p-2 hover:bg-slate-50 transition" title="กลับไปหน้าหลัก">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    </button>
                    <h2 class="text-2xl font-bold text-slate-800 ml-4">สร้างรายงานสรุปเป็นข้อความ</h2>
                </div>
                <div class="space-y-4">
                     <div>
                         <label class="block text-sm font-medium text-slate-700 mb-2">1. รูปแบบรายงาน</label>
                         <div class="flex gap-4">
                             <label class="flex items-center"><input type="radio" name="text-report-type" value="by-task" checked class="h-4 w-4 text-indigo-600 border-slate-300 focus:ring-indigo-500"><span class="ml-2 text-sm text-slate-600">รายงานตามงาน</span></label>
                             <label class="flex items-center"><input type="radio" name="text-report-type" value="by-date" class="h-4 w-4 text-indigo-600 border-slate-300 focus:ring-indigo-500"><span class="ml-2 text-sm text-slate-600">รายงานตามวันที่</span></label>
                         </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                             <div class="flex justify-between items-center mb-1"><label for="text-report-task-select" class="block text-sm font-medium text-slate-700">2. เลือกงาน</label><button id="text-report-select-all-tasks" class="text-xs font-semibold text-indigo-600 hover:text-indigo-800">เลือกทั้งหมด</button></div>
                             <select id="text-report-task-select" multiple class="w-full text-sm border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                             <div class="flex justify-between items-center mb-1"><label for="text-report-floor-select" class="block text-sm font-medium text-slate-700">3. เลือกชั้น</label><button id="text-report-select-all-floors" class="text-xs font-semibold text-indigo-600 hover:text-indigo-800">เลือกทั้งหมด</button></div>
                             <select id="text-report-floor-select" multiple class="w-full text-sm border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                    </div>
                    <div>
                         <button id="generate-text-report-btn" class="w-full sm:w-auto text-sm bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>สร้างรายงาน</button>
                    </div>
                    <div class="pt-4 border-t border-slate-200">
                         <div class="flex justify-between items-center mb-2"><label for="text-report-output" class="block text-sm font-medium text-slate-700">4. รายงานสำหรับส่งไลน์ (กดเพื่อคัดลอก)</label><button id="copy-text-report-btn" class="text-xs font-semibold text-indigo-600 hover:text-indigo-800">คัดลอก</button></div>
                         <textarea id="text-report-output" rows="12" class="w-full text-sm font-mono bg-slate-50 border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" readonly placeholder="ผลลัพธ์จะแสดงที่นี่..."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Overall Plan Page -->
            <div id="overall-plan-page" class="hidden page-container page-wrapper">
                 <div class="flex items-center mb-6"><button class="back-to-menu-btn bg-white border border-slate-300 rounded-md p-2 hover:bg-slate-50 transition" title="กลับไปหน้าหลัก"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button><h2 class="text-2xl font-bold text-slate-800 ml-4">แผนงานรวม</h2></div>
                 <div id="overall-plan-content-wrapper"></div>
            </div>

            <!-- Inspection Plan Page -->
            <div id="inspection-plan-page" class="hidden page-container page-wrapper">
                 <div class="flex items-center mb-6"><button class="back-to-menu-btn bg-white border border-slate-300 rounded-md p-2 hover:bg-slate-50 transition" title="กลับไปหน้าหลัก"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button><h2 class="text-2xl font-bold text-slate-800 ml-4">แผนส่งตรวจ</h2></div>
                 <div id="inspection-plan-content-wrapper"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="update-task-modal" class="modal-overlay"><div class="modal-content" id="update-task-modal-content"></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- SETUP & CONFIGURATION ---
            const SUPABASE_URL = 'https://egzkqnszlitqmvfinafh.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVnemtxbnN6bGl0cW12ZmluYWZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyMDE4NjIsImV4cCI6MjA3NDc3Nzg2Mn0.V0eyxowAdkQZOOt1m7cOzxFKAGjgzla2TjwXmJXScSs';
            
            const TASKS_WETWORK = [
                { id: 'texa_wall', name: 'งานผนัง Texca Wall', shortName: 'Texca Wall', group: 'งานผนัง' }, { id: 'topping', name: 'งานเทท๊อปปิ้ง', shortName: 'ท๊อปปิ้ง', group: 'งานผนัง' }, { id: 'system_electric', name: 'ไฟฟ้า', shortName: 'ไฟฟ้า', group: 'งานระบบ' }, { id: 'system_plumbing', name: 'ประปา', shortName: 'ประปา', group: 'งานระบบ' }, { id: 'system_ac', name: 'แอร์', shortName: 'แอร์', group: 'งานระบบ' }, { id: 'tile_kitchen', name: 'กระเบื้องครัว', shortName: 'กระเบื้องครัว', group: 'งานกระเบื้อง' }, { id: 'tile_balcony', name: 'กระเบื้องระเบียง', shortName: 'กระเบื้องระเบียง', group: 'งานกระเบื้อง' }, { id: 'tile_bathroom', name: 'กระเบื้องห้องน้ำ', shortName: 'กระเบื้องห้องน้ำ', group: 'งานกระเบื้อง' }, { id: 'ceiling_frame_main', name: 'ขึ้นโครงฝ้า (ห้องพัก)', shortName: 'โครงฝ้า (ห้องพัก)', group: 'งานฝ้า' }, { id: 'ceiling_board_main', name: 'ยิงแผ่นฝ้า (ห้องพัก)', shortName: 'ยิงฝ้า (ห้องพัก)', group: 'งานฝ้า' }, { id: 'ceiling_frame_bathroom', name: 'ขึ้นโครงฝ้า (ห้องน้ำ)', shortName: 'โครงฝ้า (ห้องน้ำ)', group: 'งานฝ้า' }, { id: 'ceiling_board_bathroom', name: 'ยิงแผ่นฝ้า (ห้องน้ำ)', shortName: 'ยิงฝ้า (ห้องน้ำ)', group: 'งานฝ้า' }, { id: 'skim_coat', name: 'งานสกิม', shortName: 'สกิม', group: 'งานสกิมทาสี' }, { id: 'cm_inspection', name: 'กำหนดส่งตรวจ CM wet work', shortName: 'ตรวจ CM', group: 'งานส่งตรวจ', isInspection: true }, { id: 'qc_inspection', name: 'กำหนดส่งตรวจ QC wet work', shortName: 'ตรวจ QC', group: 'งานส่งตรวจ', isInspection: true }
            ];
            const TASKS_ENDPRODUCT = [
                { id: 'ep_electric', name: 'ไฟฟ้า', shortName: 'ไฟฟ้า', group: 'งานระบบ' },
                { id: 'ep_plumbing', name: 'ประปา', shortName: 'ประปา', group: 'งานระบบ' },
                { id: 'ep_ac', name: 'แอร์', shortName: 'แอร์', group: 'งานระบบ' },
                { id: 'ep_aluminum', name: 'หน้าต่างประตู อะลูมิเนียม', shortName: 'อลูมิเนียม', group: 'งานติดตั้ง' },
                { id: 'ep_furniture', name: 'งานติดตั้งเฟอร์นิเจอร์ (ชุดครัว)', shortName: 'เฟอร์นิเจอร์', group: 'งานติดตั้ง' },
                { id: 'ep_door', name: 'งานติดตั้งประตู', shortName: 'ประตู', group: 'งานติดตั้ง' },
                { id: 'ep_floor', name: 'งานปูพื้นไม้', shortName: 'พื้นไม้', group: 'งานพื้น' },
                { id: 'ep_paint', name: 'งานทาสี', shortName: 'ทาสี', group: 'งานสี' },
                { id: 'ep_cm_inspection', name: 'ตรวจ cm', shortName: 'ตรวจ CM', group: 'งานส่งตรวจ', isInspection: true },
                { id: 'ep_qc_inspection', name: 'ตรวจ Qc', shortName: 'ตรวจ QC', group: 'งานส่งตรวจ', isInspection: true }
            ];

            const ALL_TASKS = [...TASKS_WETWORK, ...TASKS_ENDPRODUCT];
            const TASK_GROUPS_WETWORK = ['งานผนัง', 'งานระบบ', 'งานกระเบื้อง', 'งานฝ้า', 'งานสกิมทาสี', 'งานส่งตรวจ'];
            const TASK_GROUPS_ENDPRODUCT = ['งานระบบ', 'งานติดตั้ง', 'งานพื้น', 'งานสี', 'งานส่งตรวจ'];

            const FLOORS_CONFIG = { 2: { rooms: 18, prefix: '2' }, 3: { rooms: 21, prefix: '3' }, 4: { rooms: 21, prefix: '4' }, 5: { rooms: 21, prefix: '5' }, 6: { rooms: 21, prefix: '6' }, 7: { rooms: 21, prefix: '7' }, 8: { rooms: 21, prefix: '8' }, };
            const CATEGORY_COLORS = { 
                'งานผนัง':       { bg: 'bg-emerald-400', border: 'border-l-emerald-500', bgSoft: 'bg-emerald-50',  text: 'text-emerald-700', bgHeader: 'bg-emerald-100' }, 
                'งานระบบ':      { bg: 'bg-cyan-400',    border: 'border-l-cyan-500',    bgSoft: 'bg-cyan-50',     text: 'text-cyan-700',    bgHeader: 'bg-cyan-100' }, 
                'งานกระเบื้อง':  { bg: 'bg-orange-400',  border: 'border-l-orange-500',  bgSoft: 'bg-orange-50',   text: 'text-orange-700',  bgHeader: 'bg-orange-100' }, 
                'งานฝ้า':       { bg: 'bg-purple-400',  border: 'border-l-purple-500',  bgSoft: 'bg-purple-50',   text: 'text-purple-700',  bgHeader: 'bg-purple-100' }, 
                'งานสกิมทาสี':    { bg: 'bg-pink-400',    border: 'border-l-pink-500',    bgSoft: 'bg-pink-50',     text: 'text-pink-700',    bgHeader: 'bg-pink-100' }, 
                'งานส่งตรวจ':    { bg: 'bg-blue-400',    border: 'border-l-blue-500',    bgSoft: 'bg-blue-50',     text: 'text-blue-700',    bgHeader: 'bg-blue-100' }, 
                'งานติดตั้ง':    { bg: 'bg-yellow-400',  border: 'border-l-yellow-500',  bgSoft: 'bg-yellow-50',   text: 'text-yellow-700',  bgHeader: 'bg-yellow-100' },
                'งานพื้น':      { bg: 'bg-lime-400',    border: 'border-l-lime-500',    bgSoft: 'bg-lime-50',     text: 'text-lime-700',    bgHeader: 'bg-lime-100' },
                'งานสี':        { bg: 'bg-rose-400',    border: 'border-l-rose-500',    bgSoft: 'bg-rose-50',     text: 'text-rose-700',    bgHeader: 'bg-rose-100' },
            };
            const PAGES = [
                { id: 'report-page', name: 'รายงานสรุป', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3a1 1 0 000 2v11a1 1 0 100 2h14a1 1 0 100-2V5a1 1 0 000-2H3zM12 11a1 1 0 100 2h3a1 1 0 100-2h-3zM5 9a1 1 0 100 2h3a1 1 0 100-2H5zM5 5a1 1 0 100 2h3a1 1 0 100-2H5z" /></svg>` },
                { id: 'text-report-page', name: 'สร้างรายงาน', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>` },
                { id: 'overall-plan-page', name: 'แผนงานรวม', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>` },
                { id: 'inspection-plan-page', name: 'แผนส่งตรวจ', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>` },
            ];
            
            // --- APPLICATION STATE ---
            let supabaseClient;
            let projectData = {};
            let currentCalendarYear = new Date().getFullYear();
            let currentCalendarMonth = new Date().getMonth();
            let isMultiSelectMode = false;
            let selectedCells = new Set();
            let saveTimeout;
            let currentReportType = 'wetwork';

            // --- UTILITY FUNCTIONS ---
            /** Displays a temporary feedback message on the UI. */
            function showFeedback(message, isError = false) {
                 const feedbackMsg = document.getElementById('data-feedback-msg');
                 if (!feedbackMsg) return;
                 feedbackMsg.textContent = message;
                 feedbackMsg.className = `text-sm font-medium mt-2 h-5 ${isError ? 'text-red-600' : 'text-green-600'}`;
                 setTimeout(() => { feedbackMsg.textContent = ''; }, 3000);
            }
            /** Parses a YYYY-MM-DD string into a local Date object to avoid timezone issues. */
            function parseDateAsLocal(dateString) { if (!dateString) return null; const [year, month, day] = dateString.split('-').map(Number); return new Date(year, month - 1, day); }
            /** Formats a YYYY-MM-DD string into a Thai date format. */
            function formatThaiDate(dateString, longMonth = false) { if (!dateString) return null; const date = parseDateAsLocal(dateString); if (isNaN(date)) return null; const year = (date.getFullYear() + 543).toString().slice(-2); const options = { day: 'numeric', month: longMonth ? 'long' : 'short', }; return `${new Intl.DateTimeFormat('th-TH', options).format(date)} ${year}`; }

            // --- DATA MANAGEMENT ---
            /** Initializes the Supabase client. */
            function initializeSupabase() {
                try {
                    if (SUPABASE_URL.includes('YOUR_SUPABASE_URL') || SUPABASE_ANON_KEY.includes('YOUR_SUPABASE_ANON_KEY')) {
                        console.warn("Supabase credentials not set. App will run in local mode.");
                        return null;
                    }
                    return supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                } catch (e) {
                    console.error("Error initializing Supabase:", e);
                    return null;
                }
            }

            /** Generates the initial data structure if none exists. */
            function generateInitialStructure() {
                 const data = {};
                 for (const floor in FLOORS_CONFIG) {
                     data[floor] = [];
                     const { rooms, prefix } = FLOORS_CONFIG[floor];
                     for (let i = 1; i <= rooms; i++) {
                         const room = { id: `floor-${floor}-room-${i}`, name: `ห้อง ${prefix}${String(i).padStart(2, '0')}`, tasks: {} };
                         ALL_TASKS.forEach(task => { room.tasks[task.id] = { completed: false, dueDate: null, history: [], note: '' }; });
                         data[floor].push(room);
                     }
                 }
                 return data;
            }

            /** Loads data from Supabase or LocalStorage, falling back to generating a new structure. */
            async function initializeData() {
                if (!supabaseClient) {
                    console.log("Running in local mode.");
                    projectData = JSON.parse(localStorage.getItem('projectProgressData_VAY_v5_local')) || generateInitialStructure();
                } else {
                    console.log("Fetching data from Supabase...");
                    const { data, error } = await supabaseClient.from('progress_data').select('*');
                    if (error) { console.error("Error fetching data:", error); showFeedback('ไม่สามารถโหลดข้อมูลได้', true); return; }

                    if (data && data.length > 0) {
                        projectData = {};
                        data.forEach(row => {
                            if (!projectData[row.floor_number]) projectData[row.floor_number] = [];
                            projectData[row.floor_number].push({ id: row.room_id, name: row.room_name, tasks: row.tasks });
                        });
                        console.log("Data loaded from Supabase.");
                    } else {
                        console.log("No data in Supabase. Generating initial structure.");
                        projectData = generateInitialStructure();
                        await saveData();
                    }
                }
                // Data Integrity Check: Ensure all tasks exist for all rooms.
                for (const floor in projectData) { 
                    projectData[floor].forEach(room => { 
                        ALL_TASKS.forEach(task => { 
                            if (!room.tasks[task.id]) { 
                                room.tasks[task.id] = { completed: false, dueDate: null, history: [], note: '' }; 
                            } 
                        }); 
                    }); 
                }
            }

            /** Saves the current projectData to Supabase or LocalStorage. */
            async function saveData() { 
                if (!supabaseClient) { 
                    localStorage.setItem('projectProgressData_VAY_v5_local', JSON.stringify(projectData)); 
                    console.log("Data saved to localStorage."); 
                    return; 
                }
                const dataToSave = Object.values(projectData).flat().map(room => ({ floor_number: parseInt(room.id.split('-')[1]), room_id: room.id, room_name: room.name, tasks: room.tasks }));
                console.log(`Saving ${dataToSave.length} rooms to Supabase...`);
                const { error } = await supabaseClient.from('progress_data').upsert(dataToSave, { onConflict: 'room_id' });
                if (error) { 
                    console.error('Error saving data:', error); 
                    showFeedback('เกิดข้อผิดพลาดในการบันทึกข้อมูล', true); 
                } else { 
                    console.log('Data saved successfully.'); 
                    // Do not show feedback on every save to avoid being noisy.
                    // showFeedback('บันทึกข้อมูลออนไลน์แล้ว', false); 
                }
            }

            /** Debounces the saveData function to avoid excessive writes. */
            function saveDataDebounced() { 
                clearTimeout(saveTimeout); 
                saveTimeout = setTimeout(saveData, 1500); 
            }

            /** Updates a task's due date and history. */
            function updateTaskDueDate(taskData, newDate) {
                taskData.dueDate = newDate || null;
                // Add to history only if it's a new date
                if (newDate && !taskData.history.find(h => h.date === newDate)) { 
                    taskData.history.push({ date: newDate, setOn: new Date().toISOString() }); 
                }
                // Setting a due date implies the task is not yet completed
                if (newDate) {
                    taskData.completed = false; 
                }
                taskData.history.sort((a, b) => new Date(a.date) - new Date(b.date));
            }

            // --- UI & NAVIGATION ---
            /** Shows a specific page and hides all others. */
            function showPage(pageIdToShow) {
                document.getElementById('cover-page').classList.toggle('hidden', pageIdToShow !== 'cover-page');
                document.getElementById('app-container').classList.toggle('hidden', pageIdToShow === 'cover-page');
                PAGES.forEach(page => {
                    const el = document.getElementById(page.id);
                    if (el) el.classList.toggle('hidden', page.id !== pageIdToShow);
                });
                if (pageIdToShow !== 'cover-page') {
                    renderPageContent(pageIdToShow);
                }
            }
            /** Renders the content for the currently visible page. */
            function renderPageContent(pageId) {
                switch(pageId) {
                    case 'report-page': renderReportPage(); break;
                    case 'text-report-page': renderTextReportPage(); break;
                    case 'inspection-plan-page': renderInspectionPlanPage(); break;
                    case 'overall-plan-page': renderOverallPlanPage(); break;
                }
            }
            
            // --- UI RENDERING (COMPONENTS) ---
            /** Renders the main menu on the cover page. */
            function renderMainMenu() {
                document.getElementById('main-menu-grid').innerHTML = PAGES.map(page => `
                    <div class="menu-card" data-page="${page.id}">
                        ${page.icon}
                        <span>${page.name}</span>
                    </div>
                `).join('');
            }

            /** Renders the main report table for a selected floor. */
            function renderReportPage() {
                const reportContainer = document.getElementById('report-table-container');
                const floorFilter = document.getElementById('report-floor-filter');
                if (floorFilter.options.length === 0) { Object.keys(FLOORS_CONFIG).sort((a, b) => a - b).forEach(f => { floorFilter.innerHTML += `<option value="${f}">${f}</option>`; }); }
                const selectedFloor = floorFilter.value || Object.keys(FLOORS_CONFIG)[0];

                const TASKS = currentReportType === 'wetwork' ? TASKS_WETWORK : TASKS_ENDPRODUCT;
                const TASK_GROUPS = currentReportType === 'wetwork' ? TASK_GROUPS_WETWORK : TASK_GROUPS_ENDPRODUCT;

                let tableHTML = `<table class="report-table ${isMultiSelectMode ? 'multi-select-mode' : ''}"><thead><tr><th class="text-left!important bg-slate-100 room-header">ห้อง</th>`;
                TASK_GROUPS.forEach(group => {
                    const tasksInGroup = TASKS.filter(t => t.group === group);
                    const colorTheme = CATEGORY_COLORS[group] || {};
                    tasksInGroup.forEach(task => {
                        tableHTML += `<th class="${colorTheme.bgHeader || 'bg-slate-100'}"><div>${task.shortName}</div></th>`; 
                    });
                });
                tableHTML += '</tr></thead><tbody>';
                if(projectData[selectedFloor]) {
                    projectData[selectedFloor]
                    .slice() // Create a shallow copy to avoid modifying the original array
                    .sort((a, b) => parseInt(a.name.replace('ห้อง ', '')) - parseInt(b.name.replace('ห้อง ', '')))
                    .forEach(room => {
                        tableHTML += `<tr><td class="font-semibold text-slate-700 text-left">${room.name}</td>`;
                        TASKS.forEach(task => {
                            const taskData = room.tasks[task.id];
                            const cellId = `${selectedFloor}|${room.id}|${task.id}`;
                            let cellContent = '', cellClass = selectedCells.has(cellId) ? ' selected' : '';
                            if (taskData.completed) {
                                let noteInfo = taskData.note ? `<span class="block text-xs text-blue-600 italic mt-1 whitespace-normal" title="${taskData.note}">📝 ${taskData.note}</span>` : '';
                                
                                let followUpInfo = '';
                                if (taskData.followUp && taskData.followUp.text) {
                                    const isCompleted = taskData.followUp.completed;
                                    const textClass = isCompleted ? 'line-through text-slate-500' : 'text-purple-600';
                                    const icon = isCompleted ? '✅' : '📌';
                                    followUpInfo = `<span class="block text-xs ${textClass} italic mt-1 whitespace-normal" title="${taskData.followUp.text}">${icon} ${taskData.followUp.text}${taskData.followUp.date ? ` (${formatThaiDate(taskData.followUp.date)})` : ''}</span>`;
                                }

                                cellContent = '<div class="flex items-center justify-center w-full h-full"><svg class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div>' + noteInfo + followUpInfo;
                            } else if (taskData.dueDate) {
                                const dateObj = parseDateAsLocal(taskData.dueDate);
                                let postponementInfo = '';
                                if (taskData.history && taskData.history.length > 1) {
                                    const postponements = taskData.history.length - 1;
                                    const firstDate = parseDateAsLocal(taskData.history[0].date);
                                    if(firstDate && dateObj) {
                                        const diffDays = Math.ceil((dateObj - firstDate) / 864e5);
                                        if (diffDays > 0) postponementInfo = `<span class="block text-xs text-amber-600 mt-0.5 whitespace-nowrap">(เลื่อน ${postponements} ครั้ง, ช้า ${diffDays} วัน)</span>`; 
                                        else if (diffDays < 0) postponementInfo = `<span class="block text-xs text-green-600 mt-0.5 whitespace-nowrap">(เลื่อน ${postponements} ครั้ง, เร็วขึ้น ${Math.abs(diffDays)} วัน)</span>`;
                                        else postponementInfo = `<span class="block text-xs text-slate-500 mt-0.5 whitespace-nowrap">(เลื่อน ${postponements} ครั้ง)</span>`;
                                    }
                                }
                                let noteInfo = taskData.note ? `<span class="block text-xs text-blue-600 italic mt-1 whitespace-normal" title="${taskData.note}">📝 ${taskData.note}</span>` : '';
                                
                                let followUpInfo = '';
                                if (taskData.followUp && taskData.followUp.text) {
                                    const isCompleted = taskData.followUp.completed;
                                    const textClass = isCompleted ? 'line-through text-slate-500' : 'text-purple-600';
                                    const icon = isCompleted ? '✅' : '📌';
                                    followUpInfo = `<span class="block text-xs ${textClass} italic mt-1 whitespace-normal" title="${taskData.followUp.text}">${icon} ${taskData.followUp.text}${taskData.followUp.date ? ` (${formatThaiDate(taskData.followUp.date)})` : ''}</span>`;
                                }

                                cellContent = `<span class="font-medium">${dateObj.toLocaleDateString('th-TH', { day: '2-digit', month: 'short' })}</span>${postponementInfo}${noteInfo}${followUpInfo}`;
                                const today = new Date(); today.setHours(0,0,0,0);
                                if(dateObj < today) cellClass += ' bg-rose-50';
                            } else { 
                                 let noteInfo = taskData.note ? `<span class="block text-xs text-blue-600 italic mt-1 whitespace-normal" title="${taskData.note}">📝 ${taskData.note}</span>` : '';
                                 let followUpInfo = '';
                                if (taskData.followUp && taskData.followUp.text) {
                                    const isCompleted = taskData.followUp.completed;
                                    const textClass = isCompleted ? 'line-through text-slate-500' : 'text-purple-600';
                                    const icon = isCompleted ? '✅' : '📌';
                                    followUpInfo = `<span class="block text-xs ${textClass} italic mt-1 whitespace-normal" title="${taskData.followUp.text}">${icon} ${taskData.followUp.text}${taskData.followUp.date ? ` (${formatThaiDate(taskData.followUp.date)})` : ''}</span>`;
                                }
                                 cellContent = '-' + noteInfo + followUpInfo;
                             }
                            tableHTML += `<td class="${cellClass.trim()}" data-floor="${selectedFloor}" data-room-id="${room.id}" data-task-id="${task.id}">${cellContent}</td>`;
                        });
                        tableHTML += '</tr>';
                    });
                }
                reportContainer.innerHTML = tableHTML + '</tbody></table>';
            }
            /** Populates the select inputs for the text report page. */
            function renderTextReportPage() {
                document.getElementById('text-report-task-select').innerHTML = ALL_TASKS.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                document.getElementById('text-report-floor-select').innerHTML = Object.keys(FLOORS_CONFIG).map(f => `<option value="${f}">ชั้น ${f}</option>`).join('');
                document.getElementById('text-report-output').value = '';
            }
             /** Renders a plan page, which can be a list or calendar view. */
            function renderPlanPage(wrapperId, contentId, filterId) {
                const wrapper = document.getElementById(wrapperId);
                const isInspection = wrapperId === 'inspection-plan-content-wrapper';
                const tasks = isInspection ? ALL_TASKS.filter(t => t.isInspection) : ALL_TASKS.filter(t => !t.isInspection);
                let filterHTML = isInspection ? `<div class="flex gap-2" id="${filterId}"><label class="flex items-center cursor-pointer bg-white border px-3 py-1 rounded-md has-[:checked]:bg-indigo-100"><input type="radio" name="plan-task-type" value="cm_inspection" checked class="hidden"><span class="ml-1 text-sm font-medium">CM</span></label><label class="flex items-center cursor-pointer bg-white border px-3 py-1 rounded-md has-[:checked]:bg-indigo-100"><input type="radio" name="plan-task-type" value="qc_inspection" class="hidden"><span class="ml-1 text-sm font-medium">QC</span></label></div>` : `<select id="${filterId}" class="text-sm rounded-md">${tasks.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}</select>`;
                wrapper.innerHTML = `<div class="flex justify-between items-center gap-4 mb-6"><div class="flex items-center gap-4"><strong class="text-slate-700">เลือกแผน:</strong>${filterHTML}</div><div class="flex items-center gap-2 bg-slate-100 p-1 rounded-lg"><button data-view="list" class="view-btn active text-sm px-3 py-1 rounded-md">รายการ</button><button data-view="calendar" class="view-btn text-sm px-3 py-1 rounded-md">ปฏิทิน</button></div></div><div id="${contentId}"></div>`;
                renderPlanContent(contentId, filterId);
            }
            function renderInspectionPlanPage() { renderPlanPage('inspection-plan-content-wrapper', 'inspection-plan-content', 'inspection-type-filter'); }
            function renderOverallPlanPage() { renderPlanPage('overall-plan-content-wrapper', 'overall-plan-content', 'overall-task-filter'); }
             /** Chooses whether to render the list or calendar view for a plan page. */
            function renderPlanContent(contentId, filterId) {
                const page = document.getElementById(contentId).closest('.page-wrapper');
                const view = page.querySelector('.view-btn.active')?.dataset.view || 'list';
                if (view === 'list') renderPlanListView(contentId, filterId); else renderPlanCalendarView(contentId, filterId);
            }
            /** Renders the plan as a date-grouped list. */
            function renderPlanListView(contentId, filterId) { 
                const contentContainer = document.getElementById(contentId);
                if (!contentContainer) return;
                const filterElement = document.getElementById(filterId);
                const selectedTask = filterElement.tagName === 'SELECT' ? filterElement.value : document.querySelector(`#${filterId} input[name="plan-task-type"]:checked`).value;
                const taskDetails = ALL_TASKS.find(t => t.id === selectedTask);

                let scheduledDates = {};
                Object.values(projectData).flat().forEach(room => {
                    const dueDate = room.tasks[selectedTask]?.dueDate;
                    if (dueDate) { (scheduledDates[dueDate] = scheduledDates[dueDate] || []).push(room.name); }
                });

                const sortedDates = Object.keys(scheduledDates).sort();
                const topBorderColorClass = (CATEGORY_COLORS[taskDetails.group]?.border || 'border-l-slate-400').replace('border-l-', 'border-t-');

                let contentHTML = `<h2 class="text-2xl font-bold text-slate-800 mb-4">${taskDetails.name}</h2>`;
                if (sortedDates.length === 0) {
                    contentHTML += `<div class="text-center py-10 text-slate-500 bg-slate-50 rounded-lg">ยังไม่มีการกำหนดวันที่</div>`;
                } else {
                    contentHTML += '<div class="space-y-8">';
                    sortedDates.forEach(date => {
                        const rooms = scheduledDates[date].sort((a,b) => parseInt(a.replace('ห้อง ', '')) - parseInt(b.replace('ห้อง ', '')));
                        const formattedDate = parseDateAsLocal(date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                        contentHTML += `<div><div class="pb-2 mb-4 border-b"><strong class="text-lg font-semibold text-indigo-700">${formattedDate}</strong></div><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4">${rooms.map(roomName => `<div class="bg-white rounded-lg shadow p-3 flex flex-col items-center justify-center border-t-4 ${topBorderColorClass} hover:shadow-lg hover:-translate-y-1 transition-all"><p class="text-sm text-slate-500">ห้อง</p><p class="text-3xl font-bold text-slate-800">${roomName.replace('ห้อง ','')}</p></div>`).join('')}</div></div>`;
                    });
                    contentHTML += '</div>';
                }
                contentContainer.innerHTML = contentHTML;
             }
            /** Renders the plan as a monthly calendar. */
            function renderPlanCalendarView(contentId, filterId) { 
                const contentContainer = document.getElementById(contentId);
                if (!contentContainer) return;
                const filterElement = document.getElementById(filterId);
                const selectedTask = filterElement.tagName === 'SELECT' ? filterElement.value : document.querySelector(`#${filterId} input[name="plan-task-type"]:checked`).value;
                const taskDetails = ALL_TASKS.find(t => t.id === selectedTask);
                const firstDayOfMonth = new Date(currentCalendarYear, currentCalendarMonth, 1);
                const lastDayOfMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
                let scheduledDates = {};
                Object.values(projectData).flat().forEach(room => {
                    const dueDate = room.tasks[selectedTask]?.dueDate;
                    if (dueDate) { (scheduledDates[dueDate] = scheduledDates[dueDate] || []).push(room.name); }
                });
                const monthName = firstDayOfMonth.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
                const daysOfWeek = ['อา.', 'จ.', 'อ.', 'พ.', 'พฤ.', 'ศ.', 'ส.'];
                let contentHTML = `<div class="flex justify-between items-center mb-4"><button class="calendar-nav-btn p-2 rounded-full hover:bg-slate-100" data-direction="-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button><h2 class="text-xl md:text-2xl font-bold text-slate-800 text-center">${taskDetails.name}<br class="md:hidden"/> - ${monthName}</h2><button class="calendar-nav-btn p-2 rounded-full hover:bg-slate-100" data-direction="1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></button></div><div class="grid grid-cols-7 gap-1 text-center">${daysOfWeek.map(day => `<div class="font-semibold text-slate-600 text-sm p-2">${day}</div>`).join('')}`;
                for (let i = 0; i < firstDayOfMonth.getDay(); i++) { contentHTML += '<div></div>'; }
                for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
                    const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const roomsForDay = scheduledDates[dateStr] || [];
                    const colorTheme = CATEGORY_COLORS[taskDetails.group] || {bgSoft: 'bg-slate-100', text: 'text-slate-800'};
                    let roomsHTML = roomsForDay.length > 0 ? `<div class="flex-grow flex flex-wrap gap-1.5 mt-1 content-start">${roomsForDay.sort().map(r => `<div class="text-sm ${colorTheme.bgSoft} ${colorTheme.text} font-semibold px-2 py-1 rounded-md">${r.replace('ห้อง ', '')}</div>`).join('')}</div>` : '';
                    contentHTML += `<div class="border border-slate-200 bg-white rounded-md p-1 flex flex-col" style="min-height: 120px;"><div class="text-sm font-semibold text-slate-700">${day}</div>${roomsHTML}</div>`;
                }
                contentContainer.innerHTML = contentHTML + '</div>';
            }
            /** Generates text report grouped by task. */
            function generateReportByTask() {
                const taskIds = Array.from(document.getElementById('text-report-task-select').selectedOptions, opt => opt.value);
                const floorNums = Array.from(document.getElementById('text-report-floor-select').selectedOptions, opt => opt.value);
                const output = document.getElementById('text-report-output');
                if (taskIds.length === 0 || floorNums.length === 0) { output.value = "กรุณาเลือกอย่างน้อยหนึ่งงานและหนึ่งชั้น"; return; }
                const now = new Date();
                let report = `📋 รายงานความคืบหน้า\n🏢 โครงการ VAY CHINNAKHET\n(ข้อมูล ณ ${now.toLocaleDateString('th-TH', { day: '2-digit', month: 'long', year: 'numeric'})} ${now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}น.)\n------------------------------------\n`;
                floorNums.forEach(floor => {
                    report += `\n📍 พื้นที่: ชั้น ${floor}\n`;
                    taskIds.forEach(taskId => {
                        const task = ALL_TASKS.find(t => t.id === taskId);
                        const rooms = projectData[floor] || [];
                        const completed = rooms.filter(r => r.tasks[taskId].completed).map(r => r.name.replace('ห้อง ', ''));
                        const noPlan = rooms.filter(r => !r.tasks[taskId].completed && !r.tasks[taskId].dueDate).map(r => r.name.replace('ห้อง ', ''));
                        const pending = {};
                        rooms.filter(r => !r.tasks[taskId].completed && r.tasks[taskId].dueDate).forEach(r => { (pending[r.tasks[taskId].dueDate] = pending[r.tasks[taskId].dueDate] || []).push(r.name.replace('ห้อง ', '')); });
                        report += `\n▶️ ${task.name}\n`;
                        if (completed.length > 0) report += `  ✅ แล้วเสร็จ: ${completed.sort((a,b) => a-b).join(', ')}\n`;
                        Object.keys(pending).sort().forEach(date => { report += `  📝 ${formatThaiDate(date, true)}: ${pending[date].sort((a,b) => a-b).join(', ')}\n`; });
                        if (noPlan.length > 0) report += `  ⏳ ไม่มีแผน: ${noPlan.sort((a,b) => a-b).join(', ')}\n`;
                        if (completed.length === 0 && Object.keys(pending).length === 0 && noPlan.length === 0) report += `  ไม่มีข้อมูล\n`;
                    });
                });
                output.value = report;
            }
            /** Generates text report grouped by date for the first selected task. */
            function generateReportByDate() {
                const selectedTaskIds = Array.from(document.getElementById('text-report-task-select').selectedOptions).map(opt => opt.value);
                const selectedFloorNums = Array.from(document.getElementById('text-report-floor-select').selectedOptions).map(opt => opt.value);
                const outputArea = document.getElementById('text-report-output');

                if (selectedTaskIds.length === 0 || selectedFloorNums.length === 0) {
                    outputArea.value = "กรุณาเลือกอย่างน้อยหนึ่งงานและหนึ่งชั้น";
                    return;
                }

                const taskId = selectedTaskIds[0];
                const task = ALL_TASKS.find(t => t.id === taskId);
                
                const schedule = {};
                selectedFloorNums.forEach(floorNum => {
                    (projectData[floorNum] || []).forEach(room => {
                        const dueDate = room.tasks[taskId].dueDate;
                        if (dueDate && !room.tasks[taskId].completed) {
                            if (!schedule[dueDate]) schedule[dueDate] = [];
                            schedule[dueDate].push(room.name.replace('ห้อง ', ''));
                        }
                    });
                });
                
                const reportDate = new Date().toLocaleDateString('th-TH', { day: '2-digit', month: 'long', year: 'numeric'});
                let reportString = `🗓️ สรุปแผนงาน VAY CHINNAKHET\n`;
                reportString += `------------------------------------\n`;
                reportString += `หัวข้อ: ${task.name}\n`;
                reportString += `พื้นที่: ชั้น ${selectedFloorNums.join(', ')}\n`;
                reportString += `(ข้อมูล ณ วันที่ ${reportDate})\n\n`;

                const sortedDates = Object.keys(schedule).sort();
                if (sortedDates.length > 0) {
                    sortedDates.forEach(date => {
                        const roomsOnDate = schedule[date].sort((a,b) => a - b);
                        reportString += `📅 กำหนดแล้วเสร็จ: ${formatThaiDate(date, true)}\n`;
                        reportString += roomsOnDate.map(roomNum => `  - ห้อง ${roomNum}`).join('\n') + `\n\n`;
                    });
                } else {
                    reportString += `ไม่มีห้องที่มีกำหนดการแล้วเสร็จสำหรับงานนี้ในชั้นที่เลือก`;
                }
                
                if (selectedTaskIds.length > 1) {
                    reportString += `\n\nหมายเหตุ: รายงานตามวันที่แสดงผลสำหรับงานแรกที่เลือกเท่านั้น (${task.name})`;
                }

                outputArea.value = reportString;
            }

            // --- MODAL RENDERING & MANAGEMENT ---
            /** Opens the detailed modal for updating a single task from the report page. */
            function openTaskUpdateModal(floor, roomId, taskId) { 
                const room = projectData[floor].find(r => r.id === roomId);
                const task = ALL_TASKS.find(t => t.id === taskId);
                const taskData = room.tasks[taskId];
                const modalContent = document.getElementById('update-task-modal-content');

                let historyHTML = (taskData.history && taskData.history.length > 0) ? `<ul class="space-y-2">${taskData.history.map((entry, index) => `<li class="flex justify-between items-center text-sm p-2 bg-slate-100 rounded-md"><div class="flex items-center gap-2"><span class="font-medium text-slate-600">ครั้งที่ ${index + 1}:</span><input type="date" value="${entry.date}" class="history-date-input text-sm p-1 rounded border-slate-300" data-floor="${floor}" data-room-id="${roomId}" data-task-id="${taskId}" data-history-index="${index}"></div><button class="delete-history-btn text-slate-400 hover:text-red-600 p-1" title="ลบ" data-floor="${floor}" data-room-id="${roomId}" data-task-id="${taskId}" data-history-index="${index}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></li>`).join('')}</ul>` : '<p class="text-xs text-slate-500">ไม่มีประวัติ</p>';

                modalContent.innerHTML = `<div class="flex justify-between items-start mb-4"><h3 class="text-xl font-bold text-slate-800">อัปเดตงาน</h3><button id="close-update-task-btn" class="text-3xl font-light text-slate-400 hover:text-slate-700 leading-none">&times;</button></div><p class="text-sm text-slate-500 mb-1 font-bold">${room.name}</p><p class="text-sm text-slate-500 mb-4">${task.name}</p><button id="update-task-complete-btn" class="w-full text-center p-3 mb-4 rounded-md font-semibold text-white transition"></button><div class="bg-slate-50 p-3 rounded-md mb-4 text-sm"><p class="font-medium text-slate-700 mb-2">ประวัติวันที่</p><div class="max-h-32 overflow-y-auto pr-2">${historyHTML}</div></div><div><label for="update-task-date-input" class="block text-sm font-medium text-slate-700 mb-1">กำหนด/แก้ไขวันที่ล่าสุด</label><input type="date" id="update-task-date-input" value="${taskData.dueDate || ''}" class="w-full text-sm border-slate-300 rounded-md"></div><div class="mt-4"><label for="update-task-note-input" class="block text-sm font-medium text-slate-700 mb-1">เพิ่มโน้ต</label><input type="text" id="update-task-note-input" value="${taskData.note || ''}" class="w-full text-sm border-slate-300 rounded-md" placeholder="เช่น เหลือเก็บงาน..."></div><div id="follow-up-section" class="mt-4 pt-4 border-t"><p class="text-sm font-medium text-slate-700 mb-2">📌 งานต้องเก็บ</p><div class="space-y-2"><div><label for="follow-up-task-text" class="block text-xs font-medium text-slate-600 mb-1">รายละเอียด</label><input type="text" id="follow-up-task-text" value="${taskData.followUp?.text || ''}" class="w-full text-sm border-slate-300 rounded-md" placeholder="เช่น เก็บสีผนัง"></div><div><label for="follow-up-task-date" class="block text-xs font-medium text-slate-600 mb-1">กำหนดเสร็จ</label><input type="date" id="follow-up-task-date" value="${taskData.followUp?.date || ''}" class="w-full text-sm border-slate-300 rounded-md"></div><div class="mt-3"><label class="flex items-center cursor-pointer"><input type="checkbox" id="follow-up-task-completed" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"><span class="ml-2 text-sm font-medium text-slate-700">งานต้องเก็บแล้วเสร็จ</span></label></div></div></div><div class="flex justify-end gap-3 pt-4 mt-4 border-t"><button id="cancel-update-task-btn" class="text-sm bg-white text-slate-700 px-4 py-2 rounded-md border hover:bg-slate-50">ยกเลิก</button><button id="save-update-task-btn" data-floor="${floor}" data-room-id="${roomId}" data-task-id="${taskId}" class="text-sm bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">บันทึก</button></div>`;
                
                const completeBtn = modalContent.querySelector('#update-task-complete-btn');
                if (taskData.completed) {
                    completeBtn.textContent = 'ยกเลิก "เสร็จสิ้น"'; completeBtn.className = 'w-full text-center p-3 mb-4 rounded-md font-semibold text-white transition bg-slate-500 hover:bg-slate-600'; completeBtn.dataset.action = 'uncomplete';
                } else {
                    completeBtn.textContent = 'ทำเครื่องหมายว่า "เสร็จสิ้น"'; completeBtn.className = 'w-full text-center p-3 mb-4 rounded-md font-semibold text-white transition bg-green-500 hover:bg-green-600'; completeBtn.dataset.action = 'complete';
                }
                const followUpCheckbox = document.getElementById('follow-up-task-completed');
                if(followUpCheckbox) {
                    followUpCheckbox.checked = taskData.followUp?.completed || false;
                }
                document.getElementById('update-task-modal').classList.add('visible');
            }
            /** Closes the detailed task update modal. */
            function closeTaskUpdateModal() { 
                document.getElementById('update-task-modal').classList.remove('visible'); 
            }
            
            // --- EVENT HANDLERS ---
            /** Handles saving all changes from the task update modal. */
            function handleTaskUpdateSave(e) {
                const { floor, roomId, taskId } = e.target.dataset;
                const taskData = projectData[floor].find(r => r.id === roomId).tasks[taskId];
                taskData.note = document.getElementById('update-task-note-input').value;
                const followUpText = document.getElementById('follow-up-task-text')?.value;
                const followUpDate = document.getElementById('follow-up-task-date')?.value;
                const followUpCompleted = document.getElementById('follow-up-task-completed')?.checked;

                if (followUpText) { // Only create object if there's text
                    taskData.followUp = { 
                        text: followUpText, 
                        date: followUpDate || '', 
                        completed: followUpCompleted || false
                    };
                } else { // If text is cleared, remove the whole object
                    delete taskData.followUp; 
                }

                updateTaskDueDate(taskData, document.getElementById('update-task-date-input').value);
                saveDataDebounced(); closeTaskUpdateModal(); renderReportPage();
            }
            /** Handles changing a date within the task history list. */
            function handleHistoryDateChange(e) {
                const { floor, roomId, taskId, historyIndex } = e.target.dataset;
                const taskData = projectData[floor].find(r => r.id === roomId).tasks[taskId];
                taskData.history[historyIndex].date = e.target.value;
                taskData.history.sort((a, b) => new Date(a.date) - new Date(b.date));
                taskData.dueDate = taskData.history.length > 0 ? taskData.history[taskData.history.length - 1].date : null;
                saveDataDebounced(); openTaskUpdateModal(floor, roomId, taskId); renderReportPage();
            }
            /** Handles deleting an entry from the task history list. */
            function handleHistoryDeletion(dataset) {
                const { floor, roomId, taskId, historyIndex } = dataset;
                const taskData = projectData[floor].find(r => r.id === roomId).tasks[taskId];
                if (taskData.history && taskData.history.length > historyIndex) {
                    taskData.history.splice(historyIndex, 1);
                    taskData.dueDate = taskData.history.length > 0 ? taskData.history[taskData.history.length - 1].date : null;
                    saveDataDebounced(); openTaskUpdateModal(floor, roomId, taskId); renderReportPage();
                }
            }

            /** Handles generating and downloading an image of the report table. */
            async function handleExportReportImage() {
                const btn = document.getElementById('export-report-image-btn');
                const reportContainer = document.getElementById('report-table-container');
                const table = reportContainer.querySelector('.report-table');
                if (!table) return;

                const originalBtnContent = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> กำลังสร้าง...`;

                // Create a temporary wrapper for the export content
                const exportWrapper = document.createElement('div');
                exportWrapper.style.padding = '24px';
                exportWrapper.style.backgroundColor = '#ffffff';
                exportWrapper.style.display = 'inline-block'; // Ensures wrapper size fits content

                // Create title
                const floor = document.getElementById('report-floor-filter').value;
                const reportName = currentReportType === 'wetwork' ? 'WETWORK' : 'ENDPRODUCT';
                const title = document.createElement('h1');
                title.innerText = `รายงานสรุปงาน ${reportName} - ชั้น ${floor}`;
                title.style.fontSize = '28px';
                title.style.fontWeight = 'bold';
                title.style.marginBottom = '20px';
                title.style.color = '#1e293b'; // slate-800
                title.style.textAlign = 'center';

                // Clone the table and remove sticky positioning for the capture
                const tableClone = table.cloneNode(true);
                const stickyElements = Array.from(tableClone.querySelectorAll('thead th, tbody td:first-child'));
                stickyElements.forEach(el => {
                    el.style.position = 'static';
                    el.style.zIndex = 'auto';
                });

                exportWrapper.appendChild(title);
                exportWrapper.appendChild(tableClone);
                document.body.appendChild(exportWrapper);

                try {
                    // Wait for the next frame to ensure styles are applied
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    const canvas = await html2canvas(exportWrapper, {
                        backgroundColor: '#ffffff',
                        scale: 2 // Higher scale for better quality
                    });
                    
                    const a = document.createElement('a');
                    a.href = canvas.toDataURL('image/png');
                    a.download = `report-${reportName}-floor-${floor}-${new Date().toISOString().split('T')[0]}.png`;
                    a.click();
                } catch (error) {
                    console.error("Error exporting image:", error);
                    showFeedback("ไม่สามารถส่งออกรูปภาพได้", true);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalBtnContent;
                    document.body.removeChild(exportWrapper); // Clean up the temporary element
                }
            }

            /** Sets up all the event listeners for the application. */
            function setupEventListeners() {
                // Main navigation
                document.getElementById('main-menu-grid').addEventListener('click', e => {
                    const card = e.target.closest('.menu-card');
                    if (card) showPage(card.dataset.page);
                });
                document.getElementById('app-container').addEventListener('click', e => {
                    if (e.target.closest('.back-to-menu-btn')) showPage('cover-page');
                });

                // Report Page
                document.getElementById('report-page').addEventListener('change', e => {
                    if (e.target.id === 'report-floor-filter') renderReportPage();
                    if (e.target.id === 'multi-select-toggle') { 
                        isMultiSelectMode = e.target.checked; 
                        document.getElementById('multi-select-actions').classList.toggle('hidden', !isMultiSelectMode);
                        document.getElementById('multi-select-actions').classList.toggle('flex', isMultiSelectMode);
                        selectedCells.clear(); 
                        renderReportPage(); 
                    }
                });
                document.getElementById('report-page').addEventListener('click', e => {
                    const reportTypeBtn = e.target.closest('.report-type-btn');
                    if (reportTypeBtn) {
                        currentReportType = reportTypeBtn.dataset.reportType;
                        document.querySelectorAll('.report-type-btn').forEach(btn => btn.classList.remove('active', 'text-slate-500', 'hover:text-slate-700'));
                        reportTypeBtn.classList.add('active');
                        document.querySelectorAll('.report-type-btn:not(.active)').forEach(btn => btn.classList.add('text-slate-500', 'hover:text-slate-700'));
                        document.getElementById('report-page-title').textContent = currentReportType === 'wetwork' ? 'รายงานสรุปงาน WETWORK' : 'รายงานสรุปงาน ENDPRODUCT';
                        renderReportPage();
                        return;
                    }

                    if (e.target.closest('#export-report-image-btn')) { handleExportReportImage(); return; }
                    if (e.target.closest('#toggle-tv-mode-btn')) { document.body.classList.toggle('tv-mode'); document.getElementById('tv-mode-icon-expand').classList.toggle('hidden'); document.getElementById('tv-mode-icon-compress').classList.toggle('hidden'); }
                    const cell = e.target.closest('td[data-task-id]');
                    if (cell) {
                        if (isMultiSelectMode) {
                            const cellId = `${cell.dataset.floor}|${cell.dataset.roomId}|${cell.dataset.taskId}`;
                            if (selectedCells.has(cellId)) selectedCells.delete(cellId); else selectedCells.add(cellId);
                            cell.classList.toggle('selected');
                            document.getElementById('multi-select-count').textContent = `เลือก: ${selectedCells.size}`;
                        } else { openTaskUpdateModal(cell.dataset.floor, cell.dataset.roomId, cell.dataset.taskId); }
                    }
                });
                
                // Multi-select Actions Bar
                document.getElementById('multi-select-actions').addEventListener('click', e => {
                    const actionId = e.target.id;
                    if (selectedCells.size === 0 && actionId !== 'multi-clear-btn') return;
                    
                    selectedCells.forEach(cellId => {
                        const [floor, roomId, taskId] = cellId.split('|');
                        const room = projectData[floor]?.find(r => r.id === roomId);
                        if(!room) return;
                        const taskData = room.tasks[taskId];
                        switch(actionId) {
                            case 'multi-complete-btn': taskData.completed = true; break;
                            case 'multi-set-date-btn': updateTaskDueDate(taskData, document.getElementById('multi-set-date-input').value); break;
                            case 'multi-set-note-btn': taskData.note = document.getElementById('multi-set-note-input').value; break;
                            case 'multi-set-followup-btn': 
                                const followUpText = document.getElementById('multi-set-followup-text-input').value;
                                if (followUpText) { taskData.followUp = { text: followUpText, date: document.getElementById('multi-set-followup-date-input').value || '', completed: false }; }
                                break;
                            case 'multi-complete-followup-btn':
                                if (taskData.followUp) {
                                    taskData.followUp.completed = true;
                                }
                                break;
                            case 'multi-clear-btn':
                                taskData.completed = false; taskData.dueDate = null; taskData.history = []; taskData.note = ''; delete taskData.followUp;
                                break;
                        }
                    });
                    
                    if (actionId) {
                        saveDataDebounced();
                        showFeedback(`อัปเดต ${selectedCells.size} รายการสำเร็จ!`);
                        selectedCells.clear();
                        renderReportPage();
                    }
                });

                // Text Report Page
                document.getElementById('text-report-page').addEventListener('click', e => {
                    if (e.target.id === 'generate-text-report-btn') { (document.querySelector('input[name="text-report-type"]:checked').value === 'by-task') ? generateReportByTask() : generateReportByDate(); } 
                    else if (e.target.id === 'copy-text-report-btn') { document.getElementById('text-report-output').select(); document.execCommand('copy'); e.target.textContent = 'คัดลอกแล้ว!'; setTimeout(() => { e.target.textContent = 'คัดลอก'; }, 2000); } 
                    else if (e.target.id === 'text-report-select-all-tasks') { Array.from(document.getElementById('text-report-task-select').options).forEach(opt => opt.selected = true); } 
                    else if (e.target.id === 'text-report-select-all-floors') { Array.from(document.getElementById('text-report-floor-select').options).forEach(opt => opt.selected = true); }
                });
                
                // Plan Pages (Overall and Inspection)
                ['overall-plan-page', 'inspection-plan-page'].forEach(pageId => {
                    const page = document.getElementById(pageId);
                    if (page) {
                        const contentWrapperId = page.querySelector('div[id$="-content-wrapper"]').id;
                        const contentId = contentWrapperId.replace('-wrapper', '');
                        const filterId = contentId.replace('-content', '-type-filter') || contentId.replace('-content', '-filter'); // Adjust for different filter naming
                        page.addEventListener('change', () => renderPlanContent(contentId, filterId));
                        page.addEventListener('click', e => {
                            const btn = e.target.closest('.view-btn');
                            if (btn) { page.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderPlanContent(contentId, filterId); }
                            const navBtn = e.target.closest('.calendar-nav-btn');
                            if (navBtn) { currentCalendarMonth += parseInt(navBtn.dataset.direction); if (currentCalendarMonth < 0) { currentCalendarMonth = 11; currentCalendarYear--; } if (currentCalendarMonth > 11) { currentCalendarMonth = 0; currentCalendarYear++; } renderPlanContent(contentId, filterId); }
                        });
                    }
                });

                // Detailed Task Update Modal (from report page)
                document.getElementById('update-task-modal').addEventListener('click', (e) => {
                    const target = e.target;
                    if (target.id === 'update-task-modal' || target.id === 'cancel-update-task-btn' || target.closest('#close-update-task-btn')) closeTaskUpdateModal();
                    else if (target.id === 'save-update-task-btn') handleTaskUpdateSave(e);
                    else if (target.id === 'update-task-complete-btn') {
                         const { floor, roomId, taskId } = document.getElementById('save-update-task-btn').dataset;
                         const taskData = projectData[floor].find(r => r.id === roomId).tasks[taskId];
                         taskData.completed = (target.dataset.action === 'complete');
                         if (!taskData.completed) { 
                             // Keep follow-up even if main task is un-completed
                         }
                         taskData.note = document.getElementById('update-task-note-input').value;
                         handleTaskUpdateSave({ target: document.getElementById('save-update-task-btn') }); // Resuse save logic
                    } else if (target.closest('.delete-history-btn')) {
                        handleHistoryDeletion(target.closest('.delete-history-btn').dataset);
                    }
                });
                document.getElementById('update-task-modal').addEventListener('change', e => { 
                    if (e.target.classList.contains('history-date-input')) handleHistoryDateChange(e); 
                });
            }

            // --- INITIALIZATION ---
            /** The main function to initialize the application. */
            async function init() {
                supabaseClient = initializeSupabase();
                await initializeData();
                renderMainMenu();
                setupEventListeners();
                showPage('cover-page');
            }
            
            init(); // Start the application
        });
    </script>
</body>
</html>
